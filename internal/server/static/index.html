<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>xlog 日志搜索</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      background: #0f172a;
      color: #f8fafc;
    }
    header {
      padding: 16px 24px;
      background: #1e293b;
      border-bottom: 1px solid #334155;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    main {
      padding: 24px;
      width: 100%;
      box-sizing: border-box;
    }
    h1 {
      margin: 0;
      font-size: 22px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 16px;
      background: #1e293b;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #334155;
    }
    .form-row {
      display: flex;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .form-main {
      flex: 1;
      min-width: 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }
    .form-actions {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: flex-end;
      min-width: 200px;
    }
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
      .form-actions {
        width: 100%;
        justify-content: flex-start;
      }
    }
    .hidden {
      display: none !important;
    }
    label {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      gap: 6px;
      color: #cbd5f5;
    }
    input, select, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #f8fafc;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      border: none;
    }
    button:hover {
      background: #1d4ed8;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #111827;
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }
    th, td {
      padding: 6px 10px;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
      font-size: 13px;
    }
    td {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    th.col-time, td.col-time { width: 140px; }
    th.col-container, td.col-container { width: 150px; }
    th.col-container-id, td.col-container-id { width: 140px; }
    th.col-level, td.col-level { width: 90px; }
    th.col-stream, td.col-stream { width: 80px; }
    th.col-message, td.col-message { width: auto; }
    td.col-message {
      white-space: normal;
      overflow: visible;
    }
    th {
      background: #1e293b;
      text-align: left;
      font-weight: 600;
      color: #cbd5f5;
    }
    tbody tr:nth-child(even) {
      background: #131c32;
    }
    .timestamp {
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }
    .message {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      font-size: 12px;
    }
    .message .json-block {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid #1e293b;
      border-radius: 6px;
      padding: 8px;
      overflow-x: auto;
      max-height: 320px;
    }
    .message .json-block pre {
      margin: 0;
      white-space: pre;
      word-break: normal;
    }
    .message .json-block details {
      cursor: pointer;
    }
    .json-summary {
      font-size: 12px;
      color: #94a3b8;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
    }
    .level-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      background: #1f2937;
      color: #e2e8f0;
    }
    .level-info {
      background: rgba(37, 99, 235, 0.15);
      color: #60a5fa;
    }
    .level-warn {
      background: rgba(250, 204, 21, 0.18);
      color: #facc15;
    }
    .level-error {
      background: rgba(248, 113, 113, 0.18);
      color: #f87171;
    }
    .level-debug {
      background: rgba(148, 163, 184, 0.24);
      color: #94a3b8;
    }
    .level-trace {
      background: rgba(165, 180, 252, 0.18);
      color: #a5b4fc;
    }
    .level-fatal, .level-panic {
      background: rgba(220, 38, 38, 0.24);
      color: #f87171;
    }
    tbody tr.level-info .message { color: #bfdbfe; }
    tbody tr.level-debug .message { color: #cbd5f5; }
    tbody tr.level-trace .message { color: #e0e7ff; }
    tbody tr.level-warn .message { color: #fef08a; }
    tbody tr.level-error .message,
    tbody tr.level-fatal .message,
    tbody tr.level-panic .message { color: #fecaca; }
    tbody tr.level-unknown .level-badge {
      background: #1f2937;
      color: #cbd5f5;
    }
    .container-id {
      font-size: 12px;
      color: #94a3b8;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
    }
    .input-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .input-group select {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #f8fafc;
      min-width: 120px;
    }
    .summary {
      margin-bottom: 12px;
      font-size: 13px;
      color: #94a3b8;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .hidden-status {
      display: none;
    }
    .advanced-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }
    .pagination {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      color: #cbd5f5;
    }
    .pagination.hidden {
      display: none;
    }
    .pagination button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #1e293b;
      color: #e2e8f0;
      font-size: 13px;
    }
    .pagination button:hover:not(:disabled) {
      background: #2563eb;
      color: #fff;
    }
    .pagination button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #status {
      margin-bottom: 12px;
      font-size: 13px;
      color: #cbd5f5;
    }
    .controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .secondary-button {
      background: #1e293b;
      border: 1px solid #334155;
      color: #e2e8f0;
    }
    .secondary-button:hover {
      background: #2563eb;
      color: #fff;
    }
    .header-info {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 16px;
      text-align: right;
      font-size: 13px;
      color: #cbd5f5;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-info span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .header-info span strong {
      color: #f8fafc;
    }
    .container-combo {
      position: relative;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .container-combo input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #334155;
      background: #0f172a;
      color: #f8fafc;
    }
    .container-combo input:focus {
      outline: 2px solid #2563eb;
      border-color: #2563eb;
    }
    .combo-toggle {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 6px;
      padding: 7px 10px;
      cursor: pointer;
      color: #f8fafc;
    }
    .combo-toggle:hover {
      background: #2563eb;
    }
    .combo-menu {
      position: absolute;
      top: calc(100% + 4px);
      left: 0;
      right: 0;
      max-height: 240px;
      overflow-y: auto;
      background: #0f172a;
      border: 1px solid #334155;
      border-radius: 6px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.6);
      z-index: 10;
    }
    .combo-menu.hidden {
      display: none;
    }
    .combo-item {
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .combo-item:hover,
    .combo-item.active {
      background: rgba(37, 99, 235, 0.2);
    }
    .combo-item.selected {
      font-weight: 600;
      color: #93c5fd;
    }
    .combo-empty {
      padding: 8px 12px;
      color: #94a3b8;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>xlog 日志搜索</h1>
    <div class="header-info">
      <span>容器: <strong id="stats-containers">--</strong></span>
      <span>日志: <strong id="stats-logs">--</strong></span>
      <span>容量: <strong id="stats-size">--</strong></span>
    </div>
  </header>
  <main>
    <form id="query-form">
      <div class="form-row">
        <div class="form-main">
          <label>
            容器
            <div class="container-combo" id="container-combo">
              <input type="text" id="container-input" placeholder="输入关键字筛选容器" autocomplete="off" />
              <button type="button" id="container-toggle" class="combo-toggle" aria-haspopup="listbox" aria-expanded="false">▾</button>
              <div id="container-menu" class="combo-menu hidden" role="listbox"></div>
            </div>
          </label>
          <label>
            关键字
            <input type="text" id="search-input" placeholder="支持模糊匹配" />
          </label>
          <label>
            起始时间/范围
            <div class="input-group">
              <input type="text" id="since-input" placeholder="如 15m 或 2024-05-01T12:00:00Z" />
              <select id="since-select">
                <option value="">快捷选择</option>
                <option value="5m">近 5 分钟</option>
                <option value="10m">近 10 分钟</option>
                <option value="30m">近 30 分钟</option>
                <option value="1h">近 1 小时</option>
                <option value="6h">近 6 小时</option>
                <option value="24h">近 24 小时</option>
              </select>
            </div>
          </label>
        </div>
        <div class="form-actions">
          <div class="controls">
            <button type="submit">查询</button>
            <button type="button" id="refresh-btn" class="secondary-button">刷新容器</button>
            <button type="button" id="advanced-toggle" class="secondary-button" aria-expanded="false">展开高级筛选</button>
          </div>
        </div>
      </div>
      <div id="advanced-section" class="advanced-section hidden">
        <label>
          限制条数
          <input type="number" id="limit-input" min="1" max="1000" value="200" />
        </label>
        <label>
          流类型
          <select id="stream-select">
            <option value="">全部</option>
            <option value="stdout">stdout</option>
            <option value="stderr">stderr</option>
          </select>
        </label>
        <label>
          日志等级
          <select id="level-select">
            <option value="">全部</option>
            <option value="trace">TRACE</option>
            <option value="debug">DEBUG</option>
            <option value="info">INFO</option>
            <option value="warn">WARN</option>
            <option value="error">ERROR</option>
            <option value="fatal">FATAL</option>
            <option value="panic">PANIC</option>
          </select>
        </label>
        <label>
          截止时间
          <div class="input-group">
            <input type="text" id="until-input" placeholder="可选，RFC3339 或时长" />
            <select id="until-select">
              <option value="">快捷选择</option>
              <option value="now">现在</option>
              <option value="__clear">清除</option>
            </select>
          </div>
        </label>
      </div>
    </form>
    <div id="status" class="hidden-status">等待查询…</div>
    <div id="summary" class="summary">
      <span id="status-text">等待查询…</span>
      <span id="totals">总计: --</span>
    </div>
    <table>
      <thead>
        <tr>
          <th class="col-time">时间</th>
          <th class="col-container">容器</th>
          <th class="col-container-id">容器 ID</th>
          <th class="col-level">等级</th>
          <th class="col-stream">流</th>
          <th class="col-message">内容</th>
        </tr>
      </thead>
      <tbody id="log-table-body">
      </tbody>
    </table>
    <div id="pagination" class="pagination hidden">
      <button type="button" id="prev-page">上一页</button>
      <span id="page-info">第 1 / 1 页</span>
      <button type="button" id="next-page">下一页</button>
    </div>
  </main>
  <script>
    const containerCombo = document.getElementById('container-combo');
    const containerInput = document.getElementById('container-input');
    const containerToggle = document.getElementById('container-toggle');
    const containerMenu = document.getElementById('container-menu');
    const sinceInput = document.getElementById('since-input');
    const untilInput = document.getElementById('until-input');
    const sinceSelect = document.getElementById('since-select');
    const untilSelect = document.getElementById('until-select');
    const advancedToggle = document.getElementById('advanced-toggle');
    const advancedSection = document.getElementById('advanced-section');

    let currentParams = {};
    let currentPage = 1;
    let currentLimit = 200;
    let totalRecords = 0;
    let allContainers = [];
    let filteredContainers = [];
    let visibleContainers = [];
    let selectedContainer = '';
    let menuOpen = false;
    let highlightIndex = -1;
    let advancedVisible = false;
    const numberFormatter = new Intl.NumberFormat('zh-CN');

    function redirectToVerify() {
      window.location.href = '/verify';
    }

    function ensureAuthorized(res) {
      if (res.status === 401) {
        redirectToVerify();
        return false;
      }
      return true;
    }

    async function fetchContainers(selected) {
      try {
        const res = await fetch('/api/containers');
        if (!ensureAuthorized(res)) {
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        allContainers = Array.isArray(data) ? data : [];
        const target = selected ?? selectedContainer ?? containerInput.value.trim();
        setSelectedContainer(target || '', { render: false });
        renderContainerOptions();
      } catch (err) {
        setStatus('获取容器列表失败: ' + err.message);
      }
    }

    function renderContainerOptions(preserveHighlight = false) {
      const filterValue = containerInput.value.trim().toLowerCase();
      filteredContainers = filterValue
        ? allContainers.filter(name => name.toLowerCase().includes(filterValue))
        : [...allContainers];
      visibleContainers = filteredContainers.slice(0, 200);

      containerMenu.innerHTML = '';

      if (!preserveHighlight) {
        highlightIndex = selectedContainer
          ? visibleContainers.findIndex(name => name === selectedContainer)
          : -1;
      }

      if (visibleContainers.length === 0) {
        highlightIndex = -1;
        const empty = document.createElement('div');
        empty.className = 'combo-empty';
        empty.textContent = '无匹配容器';
        containerMenu.appendChild(empty);
        return;
      }

      if (highlightIndex >= visibleContainers.length) {
        highlightIndex = visibleContainers.length - 1;
      }
      if (highlightIndex < 0) {
        highlightIndex = 0;
      }

      const fragment = document.createDocumentFragment();
      visibleContainers.forEach((name, index) => {
        const item = document.createElement('div');
        item.className = 'combo-item';
        if (index === highlightIndex) {
          item.classList.add('active');
        }
        if (name === selectedContainer) {
          item.classList.add('selected');
        }
        item.textContent = name;
        item.dataset.index = String(index);
        item.addEventListener('mousedown', (event) => {
          event.preventDefault();
          setSelectedContainer(name);
          closeContainerMenu();
        });
        fragment.appendChild(item);
      });

      containerMenu.appendChild(fragment);
      ensureHighlightedVisible();
    }

    function openContainerMenu(preserveHighlight = false) {
      if (!menuOpen) {
        menuOpen = true;
        containerMenu.classList.remove('hidden');
      }
      containerToggle.setAttribute('aria-expanded', 'true');
      renderContainerOptions(preserveHighlight);
      updateMenuHighlight();
    }

    function closeContainerMenu() {
      if (!menuOpen) {
        return;
      }
      menuOpen = false;
      containerMenu.classList.add('hidden');
      containerToggle.setAttribute('aria-expanded', 'false');
      highlightIndex = -1;
    }

    function setSelectedContainer(value, options = {}) {
      selectedContainer = (value || '').trim();
      if (!options.keepInput) {
        containerInput.value = selectedContainer;
      }
      const idx = visibleContainers.findIndex(name => name === selectedContainer);
      if (idx >= 0) {
        highlightIndex = idx;
      } else if (!selectedContainer) {
        highlightIndex = -1;
      }
      if (options.render !== false) {
        renderContainerOptions(true);
      }
    }

    function updateMenuHighlight() {
      const items = containerMenu.querySelectorAll('.combo-item');
      items.forEach((item, index) => {
        if (index === highlightIndex) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
      ensureHighlightedVisible();
    }

    function ensureHighlightedVisible() {
      if (!menuOpen || highlightIndex < 0) {
        return;
      }
      const item = containerMenu.querySelector(`.combo-item[data-index="${highlightIndex}"]`);
      if (item) {
        item.scrollIntoView({ block: 'nearest' });
      }
    }

    function setAdvancedVisible(visible) {
      advancedVisible = visible;
      if (advancedSection) {
        advancedSection.classList.toggle('hidden', !visible);
        if (visible) {
          adjustAdvancedColumns();
        }
      }
      if (advancedToggle) {
        advancedToggle.textContent = visible ? '收起高级筛选' : '展开高级筛选';
        advancedToggle.setAttribute('aria-expanded', visible ? 'true' : 'false');
      }
    }

    function setStatus(text) {
      const el = document.getElementById('status');
      el.textContent = text;
      const summaryStatus = document.getElementById('status-text');
      if (summaryStatus) {
        summaryStatus.textContent = text;
      }
    }

    function setTotals(count) {
      const el = document.getElementById('totals');
      if (!el) {
        return;
      }
      el.textContent = `总计: ${count}`;
    }

    function updatePagination(total, page, limit, forceHide = false) {
      const pagination = document.getElementById('pagination');
      if (!pagination) {
        return;
      }
      const pageInfo = document.getElementById('page-info');
      const prevBtn = document.getElementById('prev-page');
      const nextBtn = document.getElementById('next-page');

      const totalPages = limit > 0 ? Math.max(1, Math.ceil(total / limit)) : 1;
      const current = Math.min(Math.max(page, 1), totalPages);

      if (forceHide || total <= limit || total <= 0) {
        pagination.classList.add('hidden');
      } else {
        pagination.classList.remove('hidden');
      }

      if (pageInfo) {
        pageInfo.textContent = total > 0 ? `第 ${current} / ${totalPages} 页` : '第 1 / 1 页';
      }
      if (prevBtn) {
        prevBtn.disabled = current <= 1;
      }
      if (nextBtn) {
        nextBtn.disabled = current >= totalPages;
      }
    }

    function renderLogs(logs) {
      if (!Array.isArray(logs)) {
        logs = [];
      }
      const tbody = document.getElementById('log-table-body');
      tbody.innerHTML = '';
      logs.forEach(log => {
        const row = document.createElement('tr');
        const level = (log.level || '').toLowerCase();
        if (level) {
          row.classList.add(`level-${level}`);
        } else {
          row.classList.add('level-unknown');
        }
        const levelLabel = level ? level.toUpperCase() : 'N/A';
        const levelClass = level ? `level-badge level-${level}` : 'level-badge';
        const containerId = (log.containerId || '').substring(0, 12);
        row.innerHTML = `
          <td class="col-time timestamp">${escapeHtml(formatTime(log.timestamp))}</td>
          <td class="col-container">${escapeHtml(log.containerName || '(unknown)')}</td>
          <td class="col-container-id container-id">${escapeHtml(containerId)}</td>
          <td class="col-level"><span class="${levelClass}">${escapeHtml(levelLabel)}</span></td>
          <td class="col-stream">${escapeHtml(log.stream)}</td>
          <td class="col-message message"></td>
        `;
        const messageCell = row.querySelector('.message');
        renderMessageContent(messageCell, log.message);
        tbody.appendChild(row);
      });
    }

    function formatTime(value) {
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) {
        return value;
      }
      return date.toLocaleString();
    }

    function formatNumber(value) {
      if (typeof value !== 'number' || !Number.isFinite(value)) {
        return '--';
      }
      return numberFormatter.format(value);
    }

    function formatBytes(bytes) {
      if (typeof bytes !== 'number' || !Number.isFinite(bytes) || bytes < 0) {
        return '--';
      }
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = bytes;
      let unitIndex = 0;
      while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
      }
      const precision = unitIndex === 0 ? 0 : 1;
      return `${size.toFixed(precision)} ${units[unitIndex]}`;
    }

    function escapeHtml(text) {
      return String(text ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function renderMessageContent(cell, message) {
      const raw = message ?? '';
      const trimmed = raw.trim();
      if (trimmed.startsWith('{') || trimmed.startsWith('[')) {
        try {
          const parsed = JSON.parse(trimmed);
          const formatted = JSON.stringify(parsed, null, 2);
          const details = document.createElement('details');
          details.className = 'json-block';
          details.open = true;
          const summary = document.createElement('summary');
          summary.className = 'json-summary';
          const preview = trimmed.replace(/\s+/g, ' ').slice(0, 60);
          summary.textContent = 'JSON ' + preview + (trimmed.length > 60 ? '…' : '');
          const pre = document.createElement('pre');
          pre.textContent = formatted;
          details.appendChild(summary);
          details.appendChild(pre);
          cell.appendChild(details);
          return;
        } catch (err) {
          // fall back to plain text
        }
      }
      cell.textContent = raw;
    }

    async function refreshStats() {
      try {
        const res = await fetch('/api/stats');
        if (!ensureAuthorized(res)) {
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        updateHeaderStats(data);
      } catch (err) {
        updateHeaderStats(null);
      }
    }

    function updateHeaderStats(stats) {
      const containersEl = document.getElementById('stats-containers');
      const logsEl = document.getElementById('stats-logs');
      const sizeEl = document.getElementById('stats-size');
      if (!stats) {
        containersEl.textContent = '--';
        logsEl.textContent = '--';
        sizeEl.textContent = '--';
        return;
      }
      containersEl.textContent = formatNumber(stats.containers ?? stats.containerCount ?? 0);
      logsEl.textContent = formatNumber(stats.logs ?? stats.logCount ?? 0);
      sizeEl.textContent = formatBytes(stats.sizeBytes ?? 0);
    }

    async function fetchLogs(params) {
      currentParams = { ...params };
      const query = new URLSearchParams(currentParams);
      setStatus('查询中…');
      try {
        const res = await fetch('/api/logs?' + query.toString());
        if (!ensureAuthorized(res)) {
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        const items = Array.isArray(data.items) ? data.items : (Array.isArray(data) ? data : []);
        const total = typeof data.total === 'number' ? data.total : items.length;
        const page = Number(data.page || currentParams.page || 1);
        const limitValue = Number(data.limit || currentParams.limit || currentLimit || 200);

        renderLogs(items);

        currentPage = page > 0 ? page : 1;
        currentLimit = limitValue > 0 ? limitValue : 200;
        totalRecords = total;

        const totalPages = currentLimit > 0 ? Math.max(1, Math.ceil(totalRecords / currentLimit)) : 1;
        const summaryMessage = `第 ${currentPage} / ${totalPages} 页，当前 ${items.length} 条`;
        setStatus(summaryMessage);
        setTotals(totalRecords);
        updatePagination(totalRecords, currentPage, currentLimit);
        refreshStats();
      } catch (err) {
        setStatus('查询失败: ' + err.message);
        setTotals('--');
        updatePagination(0, 1, currentLimit, true);
        refreshStats();
      }
    }

    function buildParamsFromForm() {
      const params = {};
      const containerValue = (selectedContainer || containerInput.value).trim();
      if (containerValue) params.container = containerValue;
      const search = document.getElementById('search-input').value.trim();
      if (search) params.search = search;
      const limit = document.getElementById('limit-input').value.trim();
      if (limit) params.limit = limit;
      const stream = document.getElementById('stream-select').value;
      if (stream) params.stream = stream;
      const level = document.getElementById('level-select').value;
      if (level) params.level = level;
      const since = document.getElementById('since-input').value.trim();
      if (since) params.since = since;
      const until = document.getElementById('until-input').value.trim();
      if (until) params.until = until;
      return params;
    }

    function updateURL(params) {
      const query = new URLSearchParams(params);
      const url = new URL(window.location);
      const queryString = query.toString();
      url.search = queryString ? '?' + queryString : '';
      window.history.replaceState(null, '', url);
    }

    document.getElementById('query-form').addEventListener('submit', (event) => {
      event.preventDefault();
      const params = buildParamsFromForm();
      params.page = 1;
      updateURL(params);
      fetchLogs(params);
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
      const current = (selectedContainer || containerInput.value).trim();
      fetchContainers(current);
    });

    document.getElementById('prev-page').addEventListener('click', () => changePage(-1));
    document.getElementById('next-page').addEventListener('click', () => changePage(1));

    containerInput.addEventListener('focus', () => {
      openContainerMenu();
    });

    containerInput.addEventListener('input', () => {
      selectedContainer = '';
      highlightIndex = -1;
      openContainerMenu();
    });

    if (sinceSelect && sinceInput) {
      sinceSelect.addEventListener('change', () => {
        const value = sinceSelect.value;
        if (!value) {
          return;
        }
        sinceInput.value = value;
      });
    }

    if (untilSelect && untilInput) {
      untilSelect.addEventListener('change', () => {
        const value = untilSelect.value;
        if (value === 'now') {
          untilInput.value = new Date().toISOString();
        } else if (value === '__clear') {
          untilInput.value = '';
          untilSelect.value = '';
        }
      });
    }

    containerInput.addEventListener('keydown', (event) => {
      if (event.key === 'ArrowDown') {
        if (!menuOpen) {
          openContainerMenu();
        }
        if (visibleContainers.length === 0) {
          return;
        }
        event.preventDefault();
        highlightIndex = (highlightIndex + 1) % visibleContainers.length;
        updateMenuHighlight();
      } else if (event.key === 'ArrowUp') {
        if (!menuOpen) {
          openContainerMenu();
        }
        if (visibleContainers.length === 0) {
          return;
        }
        event.preventDefault();
        highlightIndex = (highlightIndex - 1 + visibleContainers.length) % visibleContainers.length;
        updateMenuHighlight();
      } else if (event.key === 'Enter') {
        if (menuOpen && highlightIndex >= 0 && highlightIndex < visibleContainers.length) {
          event.preventDefault();
          setSelectedContainer(visibleContainers[highlightIndex]);
          closeContainerMenu();
        }
      } else if (event.key === 'Escape') {
        if (menuOpen) {
          event.preventDefault();
          closeContainerMenu();
        }
      }
    });

    containerToggle.addEventListener('click', () => {
      if (menuOpen) {
        closeContainerMenu();
      } else {
        openContainerMenu();
      }
    });

    document.addEventListener('click', (event) => {
      if (!containerCombo.contains(event.target)) {
        closeContainerMenu();
      }
    });

    if (advancedToggle) {
      advancedToggle.addEventListener('click', () => {
        setAdvancedVisible(!advancedVisible);
      });
    }

    function adjustAdvancedColumns() {
      if (!advancedSection) return;
      if (window.innerWidth < 600) {
        advancedSection.style.gridTemplateColumns = '1fr';
      } else {
        advancedSection.style.gridTemplateColumns = 'repeat(auto-fit, minmax(220px, 1fr))';
      }
    }

    window.addEventListener('resize', adjustAdvancedColumns);

    function changePage(delta) {
      const totalPages = currentLimit > 0 ? Math.max(1, Math.ceil(totalRecords / currentLimit)) : 1;
      const nextPage = Math.min(Math.max(currentPage + delta, 1), totalPages);
      if (nextPage === currentPage) {
        return;
      }
      const params = { ...currentParams, page: nextPage };
      updateURL(params);
      fetchLogs(params);
    }

    const initialParams = Object.fromEntries(new URLSearchParams(window.location.search));
    if (initialParams.search) {
      document.getElementById('search-input').value = initialParams.search;
    }
    document.getElementById('limit-input').value = initialParams.limit || '200';
    currentLimit = Number(document.getElementById('limit-input').value) || 200;
    if (initialParams.stream) {
      document.getElementById('stream-select').value = initialParams.stream;
    }
    if (initialParams.level) {
      document.getElementById('level-select').value = initialParams.level;
    }
    const initialContainer = initialParams.container || '';
    if (initialContainer) {
      setSelectedContainer(initialContainer, { render: false });
    } else {
      setSelectedContainer('', { render: false });
    }
    const advancedShouldShow = Boolean(
      (initialParams.limit && initialParams.limit !== '200') ||
      initialParams.stream ||
      initialParams.level ||
      initialParams.until
    );
    setAdvancedVisible(advancedShouldShow);
    if (initialParams.since) {
      document.getElementById('since-input').value = initialParams.since;
    }
    if (initialParams.until) {
      document.getElementById('until-input').value = initialParams.until;
    }

    fetchContainers(initialContainer).then(() => {
      if (Object.keys(initialParams).length > 0) {
        fetchLogs(initialParams);
      }
      updatePagination(0, 1, currentLimit, true);
    });

    refreshStats();
    setInterval(refreshStats, 60000);
    adjustAdvancedColumns();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>xlog 配置管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: #0f172a;
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      width: min(640px, 100%);
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      color: #f8fafc;
    }
    p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #cbd5f5;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #f8fafc;
      font-size: 14px;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      resize: vertical;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background: #2563eb;
      color: #f8fafc;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #1e293b;
      border: 1px solid #334155;
      color: #e2e8f0;
    }
    .btn-secondary:hover {
      background: #2563eb;
      color: #fff;
    }
    .message {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      color: #93c5fd;
    }
    .message.error {
      color: #f87171;
    }
  </style>
</head>
<body>
  <div class="card" style="max-width: 960px; width: 100%;">
    <h1>容器白名单与统计</h1>
    <p>输入允许采集的容器名称正则表达式（每行一条，支持 Go 正则语法）。留空表示采集所有容器。</p>
    <textarea id="patterns" placeholder="例如：
^important-service$
^prod-.*"></textarea>
    <div class="actions">
      <button type="button" class="btn-primary" id="save-btn">保存配置</button>
      <button type="button" class="btn-secondary" id="cancel-btn">放弃修改</button>
      <a href="/" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center;">返回首页</a>
    </div>
    <div class="message" id="message"></div>

    <h2 style="margin-top:24px;font-size:18px;color:#f8fafc;">容器统计</h2>
    <p style="margin-top:4px;">下表展示当前采集的容器、日志数量、估算占用以及时间范围。点击“清理日志”可删除该容器的全部历史记录。</p>
    <div class="table-wrapper" style="overflow-x:auto; margin-top:12px;">
      <table id="stats-table" style="width:100%; border-collapse: collapse; background:#111827; border-radius:8px; overflow:hidden;">
        <thead>
          <tr style="background:#1e293b; text-align:left;">
            <th style="padding:8px 12px;">容器</th>
            <th style="padding:8px 12px;">日志条数</th>
            <th style="padding:8px 12px;">估算占用</th>
            <th style="padding:8px 12px;">时间范围</th>
            <th style="padding:8px 12px;">操作</th>
          </tr>
        </thead>
        <tbody id="stats-body">
          <tr>
            <td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">加载中…</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    const textarea = document.getElementById('patterns');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const messageEl = document.getElementById('message');
    const numberFormatter = new Intl.NumberFormat('zh-CN');

    function redirectToVerify() {
      window.location.href = '/verify';
    }

    const statsBody = document.getElementById('stats-body');

    async function fetchConfig() {
      messageEl.textContent = '';
      messageEl.classList.remove('error');
      try {
        const res = await fetch('/api/config');
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        textarea.value = (data.allowPatterns || []).join('\n');
      } catch (err) {
        messageEl.textContent = '加载失败：' + err.message;
        messageEl.classList.add('error');
      }
    }

    async function fetchStats() {
      statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">加载中…</td></tr>';
      try {
        const res = await fetch('/api/containers/stats');
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        renderStats(Array.isArray(data) ? data : []);
      } catch (err) {
        statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#f87171;">加载失败：' + err.message + '</td></tr>';
      }
    }

    function renderStats(stats) {
      if (stats.length === 0) {
        statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">暂无数据</td></tr>';
        return;
      }
      statsBody.innerHTML = '';
      stats.forEach(stat => {
        const name = stat.containerName || '';
        const displayName = name || '(未命名)';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${escapeHtml(displayName)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatNumber(stat.logCount)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatBytes(stat.messageBytes)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatRange(stat.firstTimestamp, stat.lastTimestamp)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">
            <button type="button" class="btn-secondary" data-name="${escapeAttr(name)}" data-display="${escapeAttr(displayName)}">清理日志</button>
          </td>
        `;
        statsBody.appendChild(tr);
      });
      statsBody.querySelectorAll('button[data-name]').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.getAttribute('data-name');
          const display = btn.getAttribute('data-display') || name || '(未命名)';
          if (!confirm('确定清理容器 "' + display + '" 的全部日志吗？')) {
            return;
          }
          cleanupContainer(name);
        });
      });
    }

    function collectPatterns() {
      return textarea.value
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line.length > 0);
    }

    saveBtn.addEventListener('click', async () => {
      const patterns = collectPatterns();
      messageEl.textContent = '保存中…';
      messageEl.classList.remove('error');
      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allowPatterns: patterns })
        });
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        messageEl.textContent = '保存成功，配置已更新。';
        messageEl.classList.remove('error');
        fetchStats();
      } catch (err) {
        messageEl.textContent = '保存失败：' + err.message;
        messageEl.classList.add('error');
      }
    });

    cancelBtn.addEventListener('click', () => {
      fetchConfig();
    });

    async function cleanupContainer(name) {
      messageEl.textContent = '';
      messageEl.classList.remove('error');
      try {
        const res = await fetch('/api/containers/cleanup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ containerName: name })
        });
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        messageEl.textContent = '已清理容器 "' + name + '" 的日志。';
        messageEl.classList.remove('error');
        fetchStats();
      } catch (err) {
        messageEl.textContent = '清理失败：' + err.message;
        messageEl.classList.add('error');
      }
    }

    function escapeHtml(text) {
      return String(text ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function escapeAttr(text) {
      return String(text ?? '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatNumber(value) {
      return numberFormatter.format(value ?? 0);
    }

    function formatBytes(bytes) {
      if (typeof bytes !== 'number' || !Number.isFinite(bytes) || bytes <= 0) {
        return '0 B';
      }
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = bytes;
      let idx = 0;
      while (size >= 1024 && idx < units.length - 1) {
        size /= 1024;
        idx++;
      }
      const precision = idx === 0 ? 0 : 1;
      return size.toFixed(precision) + ' ' + units[idx];
    }

    function formatRange(first, last) {
      if (!first && !last) {
        return '-';
      }
      const firstText = formatTime(first);
      const lastText = formatTime(last);
      return firstText + ' ~ ' + lastText;
    }

    function formatTime(value) {
      if (!value) return '-';
      const date = new Date(value);
      if (Number.isNaN(date.getTime()) || date.getFullYear() <= 1) {
        return '-';
      }
      return date.toLocaleString();
    }

    fetchConfig();
    fetchStats();
  </script>
</body>
</html>
